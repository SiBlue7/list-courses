{% extends 'core/base.html' %}
{% block title %}{{ recipe.name }}{% endblock %}
{% block content %}
<div class="card">
    <h1>{{ recipe.name }}</h1>
    <p class="muted">Quantités indiquées pour 1 personne.</p>
    <a class="btn" href="{% url 'recipe_list' %}">Retour</a>
    <a class="btn" href="{% url 'ingredient_list' %}">Gérer les ingrédients</a>
    <a class="btn danger" href="{% url 'recipe_delete' recipe.id %}">Supprimer</a>
</div>

<div class="card">
    <h2>Ingrédients</h2>
    {% if recipe.ingredients.all %}
        {% for ingredient in recipe.ingredients.all %}
            <div class="list-item">
                <div>
                    <strong>{{ ingredient.display_name }}</strong>
                    <div class="small muted">{{ ingredient.quantity_per_person }} {{ ingredient.get_unit_display }}</div>
                </div>
                <form method="post" action="{% url 'recipe_ingredient_delete' ingredient.id %}">
                    {% csrf_token %}
                    <button class="btn" type="submit">Supprimer</button>
                </form>
            </div>
        {% endfor %}
    {% else %}
        <p class="muted">Aucun ingrédient pour le moment.</p>
    {% endif %}
</div>

<div class="card">
    <h2>Ajouter un ingrédient (recherche)</h2>
    <p>
        <label for="id_recipe_q">Nom</label>
        <input id="id_recipe_q" type="text" name="q" value="{{ ingredient_query }}" placeholder="Ex: tomate" />
    </p>
    <p>
        <label for="id_recipe_category">Catégorie</label>
        <select id="id_recipe_category" name="category">
            <option value="" {% if not selected_category %}selected{% endif %}>Toutes les catégories</option>
            <option value="none" {% if selected_category == 'none' %}selected{% endif %}>Sans catégorie</option>
            {% for category in ingredient_categories %}
                <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:'s' %}selected{% endif %}>{{ category.name }}</option>
            {% endfor %}
        </select>
    </p>

    <div id="recipe-ingredient-results" style="margin-top: 12px;">
        {% include 'core/partials/recipe_ingredient_results.html' %}
    </div>
</div>

<script>
(() => {
    const input = document.getElementById('id_recipe_q');
    const category = document.getElementById('id_recipe_category');
    const results = document.getElementById('recipe-ingredient-results');

    if (!input || !category || !results) {
        return;
    }

    let debounceTimer = null;
    let activeController = null;

    const refreshResults = () => {
        const params = new URLSearchParams();
        const query = input.value.trim();
        const categoryValue = category.value;

        if (query) {
            params.set('q', query);
        }
        if (categoryValue) {
            params.set('category', categoryValue);
        }
        params.set('partial', 'recipe_ingredients');

        if (activeController) {
            activeController.abort();
        }

        activeController = new AbortController();

        fetch(`${window.location.pathname}?${params.toString()}`, {
            method: 'GET',
            signal: activeController.signal,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error('Erreur de chargement');
                }
                return response.text();
            })
            .then((html) => {
                results.innerHTML = html;
            })
            .catch((error) => {
                if (error.name !== 'AbortError') {
                    console.error(error);
                }
            });
    };

    input.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(refreshResults, 180);
    });

    category.addEventListener('change', refreshResults);
})();
</script>
{% endblock %}
