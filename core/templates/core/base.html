{% load static %}
<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Listes de courses{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'core/css/style.css' %}" />
  </head>
  <body>
    <header>
      <nav>
        <a href="{% url 'dashboard' %}">Accueil</a>
        {% if request.user.is_authenticated %}
        <a href="{% url 'recipe_list' %}">Recettes</a>
        <a href="{% url 'ingredient_list' %}">Ingrédients</a>
        <a href="{% url 'shopping_list_create' %}">Nouvelle liste</a>
        <a href="{% url 'shopping_list_active' %}">Liste active</a>
        <a href="{% url 'shopping_list_archive' %}">Archives</a>
        <span class="muted">Connecté: {{ request.user.username }}</span>
        <form method="post" action="{% url 'logout' %}" data-preserve-scroll="false">
          {% csrf_token %}
          <button class="btn" type="submit">Déconnexion</button>
        </form>
        {% else %}
        <a href="{% url 'login' %}">Connexion</a>
        <a href="{% url 'register' %}">Créer un compte</a>
        {% endif %}
      </nav>
    </header>
    <div class="container">
      {% if messages %}
      <div class="messages">
        {% for message in messages %}
        <div class="message">{{ message }}</div>
        {% endfor %}
      </div>
      {% endif %} {% block content %}{% endblock %}
    </div>
    <script>
      (() => {
        const storageKey = 'list-courses:scroll-restore';
        const maxAgeMs = 15000;

        const restoreScroll = () => {
          const rawValue = sessionStorage.getItem(storageKey);
          if (!rawValue) {
            return;
          }

          let data = null;
          try {
            data = JSON.parse(rawValue);
          } catch (error) {
            sessionStorage.removeItem(storageKey);
            return;
          }

          if (!data || typeof data.path !== 'string' || typeof data.scrollY !== 'number' || typeof data.ts !== 'number') {
            sessionStorage.removeItem(storageKey);
            return;
          }

          if (Date.now() - data.ts > maxAgeMs) {
            sessionStorage.removeItem(storageKey);
            return;
          }

          if (window.location.pathname !== data.path) {
            return;
          }

          sessionStorage.removeItem(storageKey);
          requestAnimationFrame(() => {
            window.scrollTo(0, data.scrollY);
          });
        };

        restoreScroll();

        window.addEventListener(
          'submit',
          (event) => {
            const form = event.target;
            if (!(form instanceof HTMLFormElement)) {
              return;
            }

            if (form.dataset.preserveScroll === 'false') {
              return;
            }

            const payload = {
              path: window.location.pathname,
              scrollY: window.scrollY,
              ts: Date.now(),
            };

            sessionStorage.setItem(storageKey, JSON.stringify(payload));
          },
          true
        );
      })();
    </script>
  </body>
</html>
